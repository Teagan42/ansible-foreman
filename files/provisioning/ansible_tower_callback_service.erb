<%#
kind: snippet
name: ansible_tower_callback_service
model: ProvisioningTemplate
snippet: true
-%>
[Unit]
Description=Provisioning callback to Ansible Tower
# The script needs to execute after:
# network interfaces are configured
After=network-online.target
# dhcp scripts have run
After=NetworkManager-dispatcher.service
# ssh server is started
After=sshd.service
# the system clock has synchronized
After=time-sync.target

[Service]
Type=oneshot
ExecStart=/usr/bin/curl -k -s --data "host_config_key=<%= host_param('ansible_host_config_key') -%>" <%= host_param('ansible_tower_fqdn') -%>/api/v2/job_templates/<%= host_param('host_configure_job_id') -%>/callback/
ExecStartPost=/usr/bin/systemctl disable ansible-callback
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
<%#-%>
